#include "ssd1306_stm32.h"
#include "I2C1_WriteByte_DMA.h"
extern void i2c_writeByte(uint8_t addr, uint8_t reg, uint8_t data);

static uint8_t SSD1306_Buffer[SSD1306_WIDTH * SSD1306_HEIGHT / 8];

static const uint8_t Font5x7[][5] = {
    {0x00,0x00,0x00,0x00,0x00}, // space
    {0x00,0x00,0x5F,0x00,0x00}, // !
    {0x00,0x07,0x00,0x07,0x00}, // "
    {0x14,0x7F,0x14,0x7F,0x14}, // #
    {0x24,0x2A,0x7F,0x2A,0x12}, // $
    {0x23,0x13,0x08,0x64,0x62}, // %
    {0x36,0x49,0x55,0x22,0x50}, // &
    {0x00,0x05,0x03,0x00,0x00}, // '
    {0x00,0x1C,0x22,0x41,0x00}, // (
    {0x00,0x41,0x22,0x1C,0x00}, // )
    {0x14,0x08,0x3E,0x08,0x14}, // *
    {0x08,0x08,0x3E,0x08,0x08}, // +
    {0x00,0x50,0x30,0x00,0x00}, // ,
    {0x08,0x08,0x08,0x08,0x08}, // -
    {0x00,0x60,0x60,0x00,0x00}, // .
    {0x20,0x10,0x08,0x04,0x02}, // /
    {0x3E,0x51,0x49,0x45,0x3E}, // 0
    {0x00,0x42,0x7F,0x40,0x00}, // 1
    {0x42,0x61,0x51,0x49,0x46}, // 2
    {0x21,0x41,0x45,0x4B,0x31}, // 3
    {0x18,0x14,0x12,0x7F,0x10}, // 4
    {0x27,0x45,0x45,0x45,0x39}, // 5
    {0x3C,0x4A,0x49,0x49,0x30}, // 6
    {0x01,0x71,0x09,0x05,0x03}, // 7
    {0x36,0x49,0x49,0x49,0x36}, // 8
    {0x06,0x49,0x49,0x29,0x1E}, // 9
    {0x00,0x36,0x36,0x00,0x00}, // :
    {0x00,0x56,0x36,0x00,0x00}, // ;
    {0x08,0x14,0x22,0x41,0x00}, // <
    {0x14,0x14,0x14,0x14,0x14}, // =
    {0x00,0x41,0x22,0x14,0x08}, // >
    {0x02,0x01,0x51,0x09,0x06}, // ?
    {0x32,0x49,0x79,0x41,0x3E}, // @
    {0x7E,0x11,0x11,0x11,0x7E}, // A
    {0x7F,0x49,0x49,0x49,0x36}, // B
    {0x3E,0x41,0x41,0x41,0x22}, // C
    {0x7F,0x41,0x41,0x22,0x1C}, // D
    {0x7F,0x49,0x49,0x49,0x41}, // E
    {0x7F,0x09,0x09,0x09,0x01}, // F
    {0x3E,0x41,0x49,0x49,0x7A}, // G
    {0x7F,0x08,0x08,0x08,0x7F}, // H
    {0x00,0x41,0x7F,0x41,0x00}, // I
    {0x20,0x40,0x41,0x3F,0x01}, // J
    {0x7F,0x08,0x14,0x22,0x41}, // K
    {0x7F,0x40,0x40,0x40,0x40}, // L
    {0x7F,0x02,0x0C,0x02,0x7F}, // M
    {0x7F,0x04,0x08,0x10,0x7F}, // N
    {0x3E,0x41,0x41,0x41,0x3E}, // O
    {0x7F,0x09,0x09,0x09,0x06}, // P
    {0x3E,0x41,0x51,0x21,0x5E}, // Q
    {0x7F,0x09,0x19,0x29,0x46}, // R
    {0x46,0x49,0x49,0x49,0x31}, // S
    {0x01,0x01,0x7F,0x01,0x01}, // T
    {0x3F,0x40,0x40,0x40,0x3F}, // U
    {0x1F,0x20,0x40,0x20,0x1F}, // V
    {0x3F,0x40,0x38,0x40,0x3F}, // W
    {0x63,0x14,0x08,0x14,0x63}, // X
    {0x07,0x08,0x70,0x08,0x07}, // Y
    {0x61,0x51,0x49,0x45,0x43}, // Z
};

static void ssd1306_command(uint8_t c) { i2c_writeByte(SSD1306_ADDR, 0x00, c); }
static void ssd1306_data(uint8_t d) { i2c_writeByte(SSD1306_ADDR, 0x40, d); }

void SSD1306_Init(void){
    ssd1306_command(0xAE); 
    ssd1306_command(0x20); ssd1306_command(0x00);
    ssd1306_command(0xB0); ssd1306_command(0xC8);
    ssd1306_command(0x00); ssd1306_command(0x10);
    ssd1306_command(0x40); ssd1306_command(0x81); ssd1306_command(0xFF);
    ssd1306_command(0xA1); ssd1306_command(0xA6);
    ssd1306_command(0xA8); ssd1306_command(0x3F);
    ssd1306_command(0xA4); ssd1306_command(0xD3); ssd1306_command(0x00);
    ssd1306_command(0xD5); ssd1306_command(0xF0);
    ssd1306_command(0xD9); ssd1306_command(0x22);
    ssd1306_command(0xDA); ssd1306_command(0x12);
    ssd1306_command(0xDB); ssd1306_command(0x20);
    ssd1306_command(0x8D); ssd1306_command(0x14);
    ssd1306_command(0xAF); 
}

void SSD1306_Clear(void){
    for(int i=0;i<sizeof(SSD1306_Buffer);i++) SSD1306_Buffer[i]=0;
}

void SSD1306_UpdateScreen(void){
    for(uint8_t page=0; page<8; page++){
        ssd1306_command(0xB0 + page);
        ssd1306_command(0x00);
        ssd1306_command(0x10);
        for(uint8_t col=0; col<SSD1306_WIDTH; col++){
            ssd1306_data(SSD1306_Buffer[page*SSD1306_WIDTH + col]);
        }
    }
}

void SSD1306_UpdateScreen_DMA(void){
    for(uint8_t page = 0; page < 8; page++){
        ssd1306_command(0xB0 + page); 
        ssd1306_command(0x00);        
        ssd1306_command(0x10);        

        
        i2c_writeBytes_DMA(SSD1306_ADDR, 0x40, &SSD1306_Buffer[page * SSD1306_WIDTH], SSD1306_WIDTH);
    }
}

void SSD1306_DrawChar(uint8_t x, uint8_t y, char c){
    if(c<32 || c>127) c='?';
    for(uint8_t i=0;i<5;i++)
        SSD1306_Buffer[x + (y/8)*SSD1306_WIDTH + i] = Font5x7[c-32][i];
    SSD1306_Buffer[x + (y/8)*SSD1306_WIDTH + 5] = 0x00;
}

void SSD1306_DrawString(uint8_t x, uint8_t y, const char* str){
    while(*str){
        SSD1306_DrawChar(x,y,*str++);
        x+=6;
        if(x+6>SSD1306_WIDTH){ x=0; y+=8; }
    }
}

void SSD1306_DrawPixel(uint8_t x, uint8_t y, uint8_t color){
    if(x >= SSD1306_WIDTH || y >= SSD1306_HEIGHT) return;

    if(color)
        SSD1306_Buffer[x + (y/8)*SSD1306_WIDTH] |= 1 << (y % 8);
    else
        SSD1306_Buffer[x + (y/8)*SSD1306_WIDTH] &= ~(1 << (y % 8));
}

void SSD1306_DrawBitmap(uint8_t x, uint8_t y, const uint8_t *bitmap, uint8_t w, uint8_t h){
    for(uint8_t i=0; i<w; i++){
        for(uint8_t j=0; j<h; j++){
            uint8_t byte = bitmap[i + (j/8)*w];
            if(byte & (1 << (j % 8)))
                SSD1306_DrawPixel(x+i, y+j, 1);
            else
                SSD1306_DrawPixel(x+i, y+j, 0);
        }
    }
}
